# -*- coding: utf-8 -*-
"""OpenAI_API.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KTIyyJPTtoYy6_JNfBNbkYRKc6ntOAHI
"""

# app.py
import os, json, time, secrets, re
from datetime import datetime
from pathlib import Path

import requests
import streamlit as st

# =========================
# App Config
# =========================
st.set_page_config(page_title="ç„å­¦å°åŠ©æ‰‹ï¼ˆå•æ¬¡ä»˜è´¹ï¼‰", page_icon="ğŸ”®", layout="wide")

APP_TITLE = "ğŸ”® ç„å­¦å°åŠ©æ‰‹ï¼ˆå…«å­— / æ˜Ÿåº§ / å¡”ç½—ï¼‰"
DEFAULT_MODEL = "gpt-4.1-mini"
PRICE_YUAN = "4.99"
CREDITS_PER_PAY = 1

CREDITS_FILE = "credits.json"
REPORTS_FILE = "pay_reports.json"
WECHAT_QR_FILE = "wechat_qr.png"   # æ”¾åœ¨ app.py åŒçº§ç›®å½•

UID_KEY = "uid"

# =========================
# Secrets / Keys
# =========================
def get_secret(name: str, default: str = "") -> str:
    # streamlit cloud: st.secrets
    # local: .streamlit/secrets.toml
    # fallback: env var
    if name in st.secrets:
        return str(st.secrets[name])
    return os.getenv(name, default)

OPENAI_API_KEY = get_secret("OPENAI_API_KEY", "")
ADMIN_PASSWORD = get_secret("ADMIN_PASSWORD", "")

if not OPENAI_API_KEY:
    st.error("ç¼ºå°‘ OPENAI_API_KEYã€‚è¯·åœ¨ Streamlit Cloud çš„ Secrets æˆ–æœ¬åœ° .streamlit/secrets.toml é‡Œé…ç½®ã€‚")
    st.stop()

# =========================
# Utility: JSON load/save
# =========================
def load_json(path: str, default):
    p = Path(path)
    if not p.exists():
        return default
    try:
        return json.loads(p.read_text(encoding="utf-8"))
    except Exception:
        return default

def save_json(path: str, obj):
    Path(path).write_text(json.dumps(obj, ensure_ascii=False, indent=2), encoding="utf-8")

# =========================
# User ID: normalize / get / set
# =========================
def normalize_uid(s: str) -> str:
    s = (s or "").strip()
    # å…è®¸ï¼šä¸­æ–‡/è‹±æ–‡/æ•°å­—/ä¸‹åˆ’çº¿/çŸ­æ¨ªçº¿ï¼Œé•¿åº¦ 2~32
    s = re.sub(r"[^\w\u4e00-\u9fff\-]", "", s)
    return s[:32]

def get_user_id() -> str:
    # 1) URL å‚æ•°ä¼˜å…ˆï¼ˆåˆ†äº«é“¾æ¥å¸¦ ?uid=xxxï¼‰
    qp = st.query_params
    if UID_KEY in qp and qp[UID_KEY]:
        uid = normalize_uid(qp[UID_KEY])
        if uid:
            st.session_state[UID_KEY] = uid
            return uid

    # 2) session_state
    uid = normalize_uid(st.session_state.get(UID_KEY, ""))
    if uid:
        return uid

    # 3) å…œåº•ï¼šè‡ªåŠ¨ç”Ÿæˆ 8 ä½
    uid = secrets.token_hex(4).upper()
    st.session_state[UID_KEY] = uid
    st.query_params[UID_KEY] = uid
    return uid

def set_user_id(uid: str):
    uid = normalize_uid(uid)
    if len(uid) < 2:
        return False, "ID å¤ªçŸ­äº†ï¼ˆè‡³å°‘ 2 ä½ï¼‰ã€‚å»ºè®®ï¼šæ‰‹æœºå4ä½+æ˜µç§°ï¼Œä¾‹å¦‚ 1108_jiumingã€‚"
    st.session_state[UID_KEY] = uid
    st.query_params[UID_KEY] = uid
    return True, f"âœ… å·²åˆ‡æ¢ç”¨æˆ·IDï¼š{uid}"

# =========================
# Credits
# =========================
def get_credits(user_id: str) -> int:
    credits = load_json(CREDITS_FILE, {})
    return int(credits.get(user_id, 0))

def add_credits(user_id: str, n: int):
    credits = load_json(CREDITS_FILE, {})
    credits[user_id] = int(credits.get(user_id, 0)) + int(n)
    save_json(CREDITS_FILE, credits)
    return credits[user_id]

def spend_credits(user_id: str, n: int = 1):
    credits = load_json(CREDITS_FILE, {})
    cur = int(credits.get(user_id, 0))
    if cur < n:
        return False, cur
    credits[user_id] = cur - n
    save_json(CREDITS_FILE, credits)
    return True, credits[user_id]

# =========================
# OpenAI call (Responses API)
# =========================
def extract_output_text(resp_json: dict) -> str:
    # å…¼å®¹ output_text / output[].content[].text
    if isinstance(resp_json, dict) and resp_json.get("output_text"):
        return resp_json["output_text"]

    out = []
    for item in (resp_json.get("output") or []):
        for c in (item.get("content") or []):
            if c.get("type") in ("output_text", "text") and "text" in c:
                out.append(c["text"])
    return "\n".join(out).strip()

def call_openai(msgs, model=DEFAULT_MODEL, timeout=60):
    url = "https://api.openai.com/v1/responses"
    headers = {
        "Authorization": f"Bearer {OPENAI_API_KEY}",
        "Content-Type": "application/json",
    }
    payload = {
        "model": model,
        "input": msgs,
    }
    r = requests.post(url, headers=headers, json=payload, timeout=timeout)
    if r.status_code != 200:
        return f"âŒ OpenAI API é”™è¯¯ï¼šHTTP {r.status_code}\n\n{r.text[:1200]}"
    return extract_output_text(r.json()) or "ï¼ˆç©ºå›å¤ï¼‰"

# =========================
# Prompt builder
# =========================
MODES = {
    "æ¸©æŸ”å®‰æ…°": "ä½ æ˜¯ä¸€ä½æ¸©æŸ”ã€å…±æƒ…ã€å–„äºå®‰æ…°çš„äººã€‚ä½ ä¼šå…ˆç†è§£ç”¨æˆ·æƒ…ç»ªï¼Œå†ç»™å‡ºæ¸©æŸ”è€Œå…·ä½“çš„å»ºè®®ã€‚é¿å…è¯´æ•™ï¼Œè¯­æ°”æŸ”å’Œã€‚",
    "å…«å­—": "ä½ æ˜¯ä¸€ä½é£æ ¼æ¸©å’Œã€æªè¾è°¨æ…çš„å…«å­—è§£è¯»å¸ˆã€‚ä½ ä¼šä»¥å¨±ä¹ä¸è‡ªæˆ‘åæ€è§’åº¦è¿›è¡Œè§£è¯»ï¼Œä¸è¦ç»å¯¹åŒ–æ–­è¨€ï¼Œä¸æ¶‰åŠåŒ»ç–—/æ³•å¾‹/æŠ•èµ„å»ºè®®ã€‚",
    "æ˜Ÿåº§": "ä½ æ˜¯ä¸€ä½æ¸©æŸ”ã€æœ‰è¶£ä½†ä¸å¤¸å¼ çš„æ˜Ÿåº§è§£è¯»å¸ˆã€‚ä»¥å¨±ä¹ä¸ºä¸»ï¼Œç»™å‡ºå¯æ‰§è¡Œçš„å°å»ºè®®ï¼Œé¿å…ç»å¯¹æ–­è¨€ã€‚",
    "å¡”ç½—": "ä½ æ˜¯ä¸€ä½æ¸©æŸ”ã€å°Šé‡ç”¨æˆ·çš„å¡”ç½—è§£è¯»å¸ˆã€‚å¼ºè°ƒè¿™æ˜¯è‡ªæˆ‘æ¢ç´¢ï¼Œä¸åšç»å¯¹é¢„è¨€ã€‚ç»“æ„æ¸…æ™°ï¼šç°çŠ¶-é˜»ç¢-å»ºè®®-æé†’ã€‚",
}

DISCLAIMER = "å…è´£å£°æ˜ï¼šæœ¬åº”ç”¨å†…å®¹ä»…ä¾›å¨±ä¹ä¸è‡ªæˆ‘åæ€ï¼Œä¸æ„æˆåŒ»ç–—/æ³•å¾‹/æŠ•èµ„å»ºè®®ã€‚"

def build_msgs(kind: str, user_text: str):
    system = MODES.get(kind, MODES["æ¸©æŸ”å®‰æ…°"])
    msgs = [
        {"role": "system", "content": system},
        {"role": "system", "content": DISCLAIMER},
        {"role": "user", "content": user_text},
    ]
    return msgs

# =========================
# UI: Sidebar (ID + menu)
# =========================
st.title(APP_TITLE)

user_id = get_user_id()
credits_left = get_credits(user_id)

st.sidebar.markdown("## èœå•")
st.sidebar.write(f"ä½ çš„ç”¨æˆ·IDï¼š`{user_id}`")
st.sidebar.write(f"å‰©ä½™æ¬¡æ•°ï¼š**{credits_left}**")
st.sidebar.caption("æç¤ºï¼šæ¢æµè§ˆå™¨/æ¸…ç¼“å­˜ä¼šå¯¼è‡´IDå˜åŒ–ï¼›å»ºè®®ä½ æ‰‹åŠ¨è®¾ç½®å›ºå®šIDã€‚")

with st.sidebar.expander("åˆ‡æ¢/è®¾ç½®ç”¨æˆ·IDï¼ˆæ¨èï¼‰", expanded=False):
    new_uid = st.text_input("è¾“å…¥ä½ çš„å›ºå®šID", value=user_id, placeholder="ä¾‹å¦‚ï¼š1108_jiuming / æ‰‹æœºå4ä½+æ˜µç§°")
    if st.button("ä¿å­˜å¹¶åˆ‡æ¢"):
        ok, msg = set_user_id(new_uid)
        if ok:
            st.success(msg)
            st.rerun()
        else:
            st.error(msg)

page = st.sidebar.radio("é€‰æ‹©é¡µé¢", ["ç”ŸæˆæŠ¥å‘Š", "è´­ä¹°æ¬¡æ•°", "ç®¡ç†å‘˜"], index=0)

st.sidebar.divider()
st.sidebar.caption("éƒ¨ç½²ç»™åŒå­¦ï¼šæŠŠä»£ç æ”¾ GitHubï¼Œå†ç”¨ Streamlit Cloud éƒ¨ç½²ï¼›Key æ”¾ Cloud Secretsã€‚")

# =========================
# Page: Buy
# =========================
def buy_page():
    st.header("è´­ä¹°æ¬¡æ•°")
    st.write(f"å•æ¬¡ä»·æ ¼ï¼š**Â¥{PRICE_YUAN}**ï¼Œæ¯æ¬¡è´­ä¹°å¢åŠ  **{CREDITS_PER_PAY}** æ¬¡ã€‚")
    st.info(f"è¯·æŠŠä½ çš„ç”¨æˆ·IDå‘ç»™ç®¡ç†å‘˜åŠ æ¬¡æ•°ï¼š`{user_id}`ï¼ˆå»ºè®®æˆªå›¾ï¼‰")

    qr_path = Path(WECHAT_QR_FILE)
    if qr_path.exists():
        st.image(str(qr_path), caption="å¾®ä¿¡æ”¶æ¬¾ç ï¼ˆä»˜æ¬¾åè¯·æŠŠäº¤æ˜“å·/å¤‡æ³¨ + ç”¨æˆ·ID å‘ç»™ç®¡ç†å‘˜ï¼‰", use_container_width=True)
    else:
        st.warning(f"æœªæ‰¾åˆ°æ”¶æ¬¾ç å›¾ç‰‡ï¼š{WECHAT_QR_FILE}ï¼ˆè¯·æ”¾åœ¨ app.py åŒçº§ç›®å½•ï¼‰")

    st.subheader("ä»˜æ¬¾åæˆ‘éœ€è¦ç»™ç®¡ç†å‘˜ä»€ä¹ˆä¿¡æ¯ï¼Ÿ")
    st.markdown(
        "- ä½ çš„ **ç”¨æˆ·ID**\n"
        "- ä»˜æ¬¾æˆªå›¾ æˆ– äº¤æ˜“å·/å¤‡æ³¨ï¼ˆä½ å¯ä»¥è®©å¯¹æ–¹å¤‡æ³¨ä½ çš„ç”¨æˆ·IDï¼‰\n"
        "- ä»˜æ¬¾æ¬¡æ•°ï¼ˆæ¯”å¦‚ä¹° 1 æ¬¡ / ä¹° 5 æ¬¡ï¼‰"
    )

# =========================
# Page: Admin
# =========================
def admin_page():
    st.header("ç®¡ç†å‘˜é¢æ¿ï¼šåŠ æ¬¡æ•°")

    if not ADMIN_PASSWORD:
        st.warning("æœªé…ç½® ADMIN_PASSWORDã€‚è¯·åœ¨ Secrets é‡Œè®¾ç½® ADMIN_PASSWORDã€‚")
        st.stop()

    pwd = st.text_input("ç®¡ç†å‘˜å¯†ç ", type="password")
    if pwd != ADMIN_PASSWORD:
        st.info("è¾“å…¥ç®¡ç†å‘˜å¯†ç åæ‰å¯æ“ä½œã€‚")
        st.stop()

    st.success("âœ… ç®¡ç†å‘˜å·²éªŒè¯")

    st.subheader("ç»™æŸä¸ª user_id åŠ æ¬¡æ•°")
    uid = st.text_input("user_idï¼ˆç”¨æˆ·ä¾§è¾¹æ ä¼šæ˜¾ç¤ºï¼‰", placeholder="ä¾‹å¦‚ï¼š1108_jiuming")
    n = st.number_input("å¢åŠ æ¬¡æ•°", min_value=1, max_value=100, value=1, step=1)

    # å…³é”®ï¼šStreamlit è¾“å…¥æ¡†ä¸éœ€è¦â€œå›è½¦â€ï¼Œè¦ç‚¹æŒ‰é’®è§¦å‘
    if st.button("âœ… ç¡®è®¤åŠ æ¬¡æ•°"):
        uid2 = normalize_uid(uid)
        if len(uid2) < 2:
            st.error("user_id ä¸åˆæ³•ï¼ˆè‡³å°‘ 2 ä½ï¼Œåªèƒ½ä¸­æ–‡/è‹±æ–‡/æ•°å­—/_/-ï¼‰ã€‚")
        else:
            new_total = add_credits(uid2, int(n))
            st.success(f"å·²ç»™ `{uid2}` å¢åŠ  {int(n)} æ¬¡ã€‚å½“å‰ä½™é¢ï¼š{new_total}")

    st.divider()
    st.subheader("å¿«é€ŸæŸ¥çœ‹ credits.jsonï¼ˆæ’æŸ¥ç”¨ï¼‰")
    if st.button("åˆ·æ–°æŸ¥çœ‹"):
        pass
    st.code(json.dumps(load_json(CREDITS_FILE, {}), ensure_ascii=False, indent=2)[:6000])

    st.divider()
    st.subheader("ä»˜æ¬¾è®°å½• pay_reports.jsonï¼ˆå¯é€‰ï¼‰")
    st.code(json.dumps(load_json(REPORTS_FILE, []), ensure_ascii=False, indent=2)[:6000])

# =========================
# Page: Generator
# =========================
def generator_page():
    st.header("ç”ŸæˆæŠ¥å‘Š")
    st.caption(DISCLAIMER)
    st.info(f"å½“å‰ç”¨æˆ·IDï¼š`{user_id}`ï¼ˆå»ºè®®ä½ è®¾ç½®å›ºå®šIDï¼Œé¿å…æ¢è®¾å¤‡åæ¬¡æ•°ä¸¢å¤±ï¼‰")

    if credits_left <= 0:
        st.warning("ä½ å½“å‰å‰©ä½™æ¬¡æ•°ä¸º 0ï¼Œè¯·å…ˆå»ã€è´­ä¹°æ¬¡æ•°ã€‘é¡µé¢ä»˜æ¬¾ï¼Œç„¶åè”ç³»ç®¡ç†å‘˜åŠ æ¬¡æ•°ã€‚")
        st.stop()

    kind = st.selectbox("é€‰æ‹©ç±»å‹", ["æ¸©æŸ”å®‰æ…°", "å…«å­—", "æ˜Ÿåº§", "å¡”ç½—"], index=0)
    topic = st.selectbox("å…³æ³¨ç‚¹ï¼ˆå¯é€‰ï¼‰", ["ç»¼åˆ", "æ„Ÿæƒ…", "å­¦ä¸š/äº‹ä¸š", "è´¢è¿", "æƒ…ç»ª/çŠ¶æ€", "äººé™…å…³ç³»"], index=0)

    st.write("è¯·å°½é‡æä¾›æ¸…æ™°ä¿¡æ¯ï¼ˆè¶Šå…·ä½“è¶Šå¥½ï¼‰ï¼š")
    user_text = st.text_area(
        "è¾“å…¥ä¿¡æ¯",
        height=180,
        placeholder="ä¾‹å¦‚ï¼š\n- æ˜Ÿåº§ï¼šå¤©èåº§ï¼Œæœ€è¿‘æƒ…ç»ªå¾ˆä½ï¼Œæƒ³çŸ¥é“æ„Ÿæƒ…æ€ä¹ˆèµ°\n- å…«å­—ï¼šxxxx-xx-xx xx:xx å‡ºç”Ÿï¼Œåœ°ç‚¹xxï¼Œå…³æ³¨äº‹ä¸š\n- å¡”ç½—ï¼šæˆ‘æŠ½åˆ° XXã€XXã€XXï¼Œé—®xxx"
    )

    col1, col2 = st.columns([1, 1])
    with col1:
        go = st.button("ğŸ”® ç”Ÿæˆï¼ˆæ¶ˆè€— 1 æ¬¡ï¼‰", use_container_width=True)
    with col2:
        st.write("")

    if go:
        text = user_text.strip()
        if not text:
            st.error("è¯·å…ˆè¾“å…¥ä¿¡æ¯ã€‚")
            st.stop()

        ok, remain = spend_credits(user_id, 1)
        if not ok:
            st.error("æ¬¡æ•°ä¸è¶³ï¼Œè¯·å…ˆè´­ä¹°ã€‚")
            st.stop()

        prompt = f"[ç±»å‹]{kind}\n[å…³æ³¨ç‚¹]{topic}\n[ç”¨æˆ·è¾“å…¥]\n{text}"
        msgs = build_msgs(kind, prompt)

        with st.spinner("æ­£åœ¨ç”Ÿæˆ..."):
            ans = call_openai(msgs)

        st.success(f"âœ… å·²ç”Ÿæˆã€‚å‰©ä½™æ¬¡æ•°ï¼š{remain}")
        st.markdown("### ç»“æœ")
        st.write(ans)

# =========================
# Router
# =========================
if page == "ç”ŸæˆæŠ¥å‘Š":
    generator_page()
elif page == "è´­ä¹°æ¬¡æ•°":
    buy_page()
else:
    admin_page()